#!/usr/bin/env bash
set -eo pipefail; [[ $JZ_TRACE ]] && set -x
source "$PLUGIN_PATH/common/functions"
source "$PLUGIN_PATH/project/functions"

#DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

list_templates() {
    # TODO: Print nice description for templates
    find $PLUGIN_PATH/project/templates -maxdepth 1 -type d -print | tail -n +2 | rev | cut -d'/' -f 1 | rev
}

_build="gradle"
_template="war"
_jee_version="7"


usage() {
    templates=$(list_templates | paste -sd "|" -)
    echo "Usage: jz project:create [groupid.]artifactid [OPTIONS]"
    echo ""
    echo "Create a Java EE project from a template"
    echo ""
    echo "Options:"
    echo "    --jee-version=7|8 (default: 7)"
    echo "    --template=$templates (default: war)"
    echo "    --st (creates a system-test project; same as --template=st)"
    echo "    --build=gradle|maven (default: gradle)"
    echo ""
    echo "Example:"
    echo "$ jz project:create jz.myapp"
    echo "    This will use some defaults (*) and create a project that..."
    echo "    - is Java EE 7-compliant (*),"
    echo "    - packages as a WAR archive (*),"
    echo "    - has group-id \"jz\","
    echo "    - has artifact-id \"myapp\","
    echo "    - and builds with Gradle (*)"
}

scaffold() {   

    apply_template $_template $jz_pj_folder_name

    if ! [[ -v JZ_CUSTOM_ROOT ]]; then
        touch .jeeez
    fi

    if [[ "$_build" == "maven" ]]; then
        rm -rf $jz_pj_artifactid/gradle
        rm -f $jz_pj_artifactid/gradlew*
        rm -f $jz_pj_artifactid/settings.gradle
        find $jz_pj_artifactid -type f -exec sed -i "s/template-artifactid/${jz_pj_artifactid}/g" {} \;
        find $jz_pj_artifactid -type f -name "build.gradle" -exec rm -f {} \;
    elif [[ "$_build" == "gradle" ]]; then
        rm -rf $jz_pj_artifactid/.mvn
        rm -f $jz_pj_artifactid/mvnw*
        find $jz_pj_artifactid -type f -name "pom.xml" -exec rm -f {} \;
    fi

    (
        cd $jz_pj_artifactid
        write_metadata_file
    )
    
    if [[ "$jz_pj_artifactid" == *-st ]]; then
        # This is a system-test project
        # Find the main project this belongs to
        parent_artifactid=${jz_pj_artifactid%-st}
        if [ -d "$parent_artifactid" ]; then
            log_info "Found parent-project @ $parent_artifactid"
            echo "COMPOSE_PROJECT_NAME=$parent_artifactid" >> $jz_pj_artifactid/.env
            find $jz_pj_artifactid -type f -exec sed -i "s/template-parent-artifactid/${parent_artifactid}/g" {} \;
            
            if [[ "$_build" == "maven" ]]; then
                find $jz_pj_artifactid -type f -exec sed -i "s/build\/libs/target/g" {} \;
            fi
            (
                APPNAME=$parent_artifactid
                for composeFile in $jz_pj_artifactid/docker-compose*.yml; do
                    create_file_from_template $composeFile $composeFile
                done
            )
        else
            log_err "Expected a main-project named '$parent_artifactid' but unable to find."
            exit 1
        fi

        log_success "Succesfully created system-test project with artifact-id '$jz_pj_artifactid' and group-id '$jz_pj_groupid' from template '$_template'."
        log_info $HR
        if [[ "$_build" == "maven" ]]; then
            log_info "Run them with 'cd $jz_pj_artifactid; ./mvnw verify'."
        else
            log_info "Run them with 'cd $jz_pj_artifactid; ./gradlew systemTestInDockerEnv'."
        fi
        log_info "This project only works in conjunction with the project named '$parent_artifactid' located parallel to this project."
        log_info "Make sure to run  the build on it at least once to generate the artifact to deploy."
        log_info $HR
    else
        log_success "Succesfully created a project with artifact-id '$jz_pj_artifactid' and group-id '$jz_pj_groupid' from template '$_template'."
        log_info $HR
        log_info "Build & run it with 'cd $jz_pj_artifactid; ./run_docker.sh'."
        log_info "Open http://localhost/$jz_pj_artifactid/resources/health when the server is started."
        log_info $HR
    fi
    #tree -C $jz_pj_artifactid/
}

plugin_main_cmd() {

    case $1 in
        -h|--help)
        usage
        exit 0
        ;;
    esac

    if [ "$1" == "" ]; then
        usage
        exit 1
    fi

    local project_name=$1
    shift

    while [ $# -gt 0 ]; do
    case "$1" in
        --jee-version=*)
        _jee_version="${1#*=}"
        ;;
        --template=*)
        _template="${1#*=}"
        ;;
        --st)
        # If we are generating a system-test project, append "-st" to project-name
        project_name="${project_name}-st"
        _template="st"
        ;;
        --build=*)
        _build="${1#*=}"
        ;;
        *)
        log_err "Invalid argument"
        exit 1
    esac
    shift
    done

    to_project_coordinates $project_name

    if ! [ -d $PLUGIN_PATH/project/templates/$_template ]; then
        log_err "No template with name '$_template'"
        exit 1
    fi

    scaffold
}

plugin_main_cmd "$@"